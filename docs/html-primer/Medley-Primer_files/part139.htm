<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Functions for Tracing the Cursor                                                                   </title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part138.htm">&lt; Previous</a><span> | </span><a href="../Medley-Primer.html">Contents</a><span> | </span><a href="part140.htm">Next &gt;</a></p><h2 style="padding-left: 35pt;text-indent: 0pt;text-align: left;">Functions for Tracing the Cursor                                                                   </h2><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 107pt;text-indent: 0pt;text-align: left;">To actually have a bitmap trace (follow) the cursor, the environment must be set up so that when the cursor enters the tracing region the trace is turned on, and when the</p><p style="padding-left: 107pt;text-indent: 0pt;line-height: 106%;text-align: left;">cursor leaves the tracing region the trace is turned off. The function <span class="s3">Establish/Trace/Data </span>will do this. Type it in as it appears (include comments that will help you remember what the function does).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(DEFINEQ (Establish/Trace/Data</p><p class="s3" style="padding-left: 143pt;text-indent: -12pt;line-height: 88%;text-align: left;">[LAMBDA (wnd tracebitmap cursor/rightoffset cursor/heightoffset GCGAGP)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * This function is called to establish the data to trace the desired bitmap. &quot;wnd&quot; is the window in which the tracing is to take place, &quot;tracebitmap&quot; is the tracing bitmap, &quot;cursor/rightoffset&quot; and &quot;cursor/heightoffset&quot; are integers which detemine the hotspot of the tracing bitmap.</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">As &quot;cursor/heightoffset and &quot;cursor/rightoffset&quot; increase the cursor hotspot moves up and to the right.</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 10pt;text-align: left;">If GCGAGP is non-NIL, GCGAG will be disabled.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 107pt;text-indent: 0pt;text-align: left;">(PROG NIL</p><p class="s3" style="padding-top: 8pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(if (OR (NULL wnd)</p><p class="s3" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: center;">(NULL tracebitmap))</p><p class="s3" style="padding-left: 197pt;text-indent: -30pt;line-height: 88%;text-align: left;">then (PLAYTUNE (LIST (CONS 1000 4000))) (RETURN))</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(if GCGAGP</p><p class="s3" style="padding-left: 167pt;text-indent: 0pt;line-height: 11pt;text-align: left;">then (GCGAG))</p><p class="s3" style="padding-top: 8pt;padding-left: 155pt;text-indent: 0pt;text-align: left;">(* * Create a blank cursor.)</p><p class="s3" style="padding-top: 8pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(SETQ *BLANKCURSOR*(BITMAPCREATE 16 16))</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(SETQ *BLANKTRACECURSOR*(CURSORCREATE *BLANKCURSOR*))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-top: 6pt;padding-left: 155pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * Set the CURSOR IN and OUT FNS for wnd to the following:)</p><p class="s3" style="padding-top: 9pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(WINDOWPROP wnd (QUOTE CURSORINFN)</p><p class="s3" style="padding-left: 143pt;text-indent: 72pt;line-height: 88%;text-align: left;">(FUNCTION SETUP/TRACE)) (WINDOWPROP wnd (QUOTE CURSOROUTFN)</p><p class="s3" style="padding-left: 215pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(FUNCTION UNTRACE/CURSOR))</p><p class="s3" style="padding-top: 9pt;padding-left: 161pt;text-indent: -6pt;line-height: 88%;text-align: left;">(* * To allow the bitmap to be set down in the window by pressing a mouse button, include this line.</p><p class="s3" style="padding-left: 161pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Otherwise, it is not needed)</p><p class="s3" style="padding-top: 8pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(WINDOWPROP wnd (QUOTE BUTTONEVENTFN)</p><p class="s3" style="padding-left: 143pt;text-indent: 72pt;line-height: 88%;text-align: left;">(FUNCTION PLACE/BITMAP/IN/WINDOW)) (WINDOWPROP wnd (QUOTE CURSOROUTFN)</p><p class="s3" style="padding-left: 143pt;text-indent: 12pt;line-height: 20pt;text-align: left;">(* * Set up Global Variables for the tracing operation) (SETQ *TRACEBITMAP* tracebitmap</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(SETQ *RIGHTTRACE/OFFSET*(OR cursor/rightoffset 0)) (SETQ *HEIGHTTRACE/OFFSET*(OR cxursor heightoffset 0)) (SETQ *OLDBITMAPPOSITION*(BITMAPCREATE (BITMAPWIDTH</p><p class="s3" style="padding-left: 161pt;text-indent: 0pt;line-height: 9pt;text-align: left;">tracebitmap)</p><p class="s3" style="padding-top: 9pt;padding-left: 161pt;text-indent: 0pt;line-height: 11pt;text-align: left;">tracebitmap)))</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(SETQ *TRACEWINDOW* wnd]))</p><p class="s3" style="padding-left: 75pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(BITMAPHEIGHT</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 107pt;text-indent: 0pt;text-align: left;">When the function <span class="s3">Establish/Trace/Data </span>is called, the functions <span class="s3">SETUP/TRACE </span>and</p><p class="s3" style="padding-left: 107pt;text-indent: 0pt;line-height: 107%;text-align: left;">UNTRACE/CURSOR <span class="p">will be installed as the values of the window’s </span>WlNDOWPROPS <span class="p">, and will be used to turn the trace on and off. Those functions should be typed in, then:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 131pt;text-indent: -24pt;line-height: 88%;text-align: left;">(DEFINEQ (SETUP/TRACE [LAMBDA (wnd)</p><p class="s3" style="padding-top: 9pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(* * This function is wnd’s CURSORINFN.</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">It simply resets the last trace position and the current tracing region. It also readvises GETMOUSESTATE to perform the trace function after each call.)</p><p class="s3" style="padding-top: 9pt;padding-left: 131pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(if *TRACEBITMAP*</p><p class="s3" style="padding-left: 167pt;text-indent: -24pt;line-height: 88%;text-align: left;">then (SETQ *LAST-TRACE-XPOS* -2000) (SETQ *LAST-TRACE-YPOS* -2000)</p><p class="s3" style="padding-left: 167pt;text-indent: 0pt;line-height: 88%;text-align: left;">(SETQ *WNDREGION* (WINDOWPROP wnd (QUOTE REGION))) (WINDOWPROP wnd (QUOTE TRACING)</p><p class="s3" style="padding-left: 191pt;text-indent: 0pt;line-height: 10pt;text-align: left;">T)</p><p class="s3" style="padding-top: 8pt;padding-left: 143pt;text-indent: 0pt;text-align: left;">(* * make the cursor disappear)</p><p class="s3" style="padding-top: 9pt;padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(CURSOR *BLANKTRACECURSOR*) (ADVISE (QUOTE GETMOUSESTATE)</p><p class="s3" style="padding-left: 179pt;text-indent: 0pt;line-height: 88%;text-align: left;">(QUOTE AFTER) NIL</p><p class="s3" style="padding-left: 179pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(QUOTE (TRACE/CURSOR]))</p><p class="s3" style="padding-top: 9pt;padding-left: 113pt;text-indent: -6pt;line-height: 88%;text-align: left;">(DEFINEQ (UNTRACE/CURSOR [LAMBDA (wnd)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * This function is wnd’s CURSOROUTFN. The function first checks if the cursor is currently being traced; if so, it replaces the tracing bitmap with what is under it and then turns tracing off by unadvising GETMOUSESTATE and setting the TRACING window property of *TRACEWINDOW* to NIL.)</p><p class="s3" style="padding-top: 9pt;padding-left: 113pt;text-indent: 0pt;text-align: left;">(if (WINDOWPROP *TRACEWINDOW*(QUOTE TRACING))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-top: 6pt;padding-left: 191pt;text-indent: -48pt;line-height: 88%;text-align: left;">then (BITBLT *OLDBITMAPPOSITION* 0 0 (SCREENBITMAP) (IPLUS (CAR *WNDREGION*)*LAST-TRACE-XPOS*) (IPLUS (CADR *WNDREGION*)*LAST-TRACE-YPOS*))</p><p class="s3" style="padding-left: 167pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(WINDOWPROP *TRACEWINDOW*(QUOTE TRACING)</p><p class="s3" style="padding-left: 287pt;text-indent: 0pt;line-height: 11pt;text-align: left;">NIL))</p><p class="s3" style="padding-top: 8pt;padding-left: 113pt;text-indent: 29pt;line-height: 177%;text-align: left;">(* * replace the original cursor shape) (CURSOR T)</p><p class="s3" style="padding-left: 113pt;text-indent: 29pt;line-height: 177%;text-align: left;">(* * unadvise GETMOUSESTATE) (UNADVISE (QUOTE GETMOUSESTATE]))</p><p style="padding-top: 7pt;padding-left: 107pt;text-indent: 0pt;text-align: left;">The function <span class="s3">SETUP/TRACE </span>has a helper function that you must also type in. It is</p><p class="s3" style="padding-left: 107pt;text-indent: 0pt;text-align: left;">TRACE/CURSOR<span class="p">:</span></p><p class="s3" style="padding-top: 8pt;padding-left: 113pt;text-indent: -6pt;line-height: 88%;text-align: left;">(DEFINEQ (TRACE/CURSOR [LAMBDA NIL</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * This function does the actual BITBLTing of the tracing bitmap. This function is called after a GETMOUSESTATE, while tracing.)</p><p class="s3" style="padding-top: 6pt;padding-left: 34pt;text-indent: 0pt;line-height: 11pt;text-align: center;">(PROG ((xpos (IDIFFERENCE (LASTMOUSEX *TRACEWINDOW*)</p><p class="s3" style="padding-left: 191pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*RIGHTTRACE/OFFSET*))</p><p class="s3" style="padding-top: 5pt;padding-left: 75pt;text-indent: 0pt;line-height: 11pt;text-align: center;">(ypos (IDIFFERENCE (LASTMOUSEY *TRACEWINDOW*)</p><p class="s3" style="padding-left: 191pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*HEIGHTTRACE/OFFSET*))</p><p class="s3" style="padding-top: 6pt;padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * If there is an error in the function, press the right button to unadvise the function. This will keep the machine from locking up.)</p><p class="s3" style="padding-top: 6pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(if (LASTMOUSESTATE RIGHT)</p><p class="s3" style="padding-left: 143pt;text-indent: 24pt;line-height: 88%;text-align: left;">then (UNADVISE (QUOTE GETMOUSESTATE))) (if (AND (NEQ xpos *LAST-TRACE-XPOS*)</p><p class="s3" style="padding-left: 197pt;text-indent: 0pt;line-height: 9pt;text-align: left;">(NEQ ypos *LAST-TRACE-YPOS*))</p><p class="s3" style="padding-left: 167pt;text-indent: 0pt;text-align: left;">then</p><p class="s3" style="padding-top: 6pt;padding-left: 143pt;text-indent: 0pt;line-height: 90%;text-align: left;">(* * Restore what was under the old position of the trace bitmap<span class="s13">)</span></p><p class="s3" style="padding-top: 6pt;padding-left: 191pt;text-indent: -24pt;line-height: 88%;text-align: left;">(BITBLT *OLDBITMAPPOSITION* 0 0 (SCREENBITMAP) (IPLUS (CAR *WNDREGION*)*LAST-TRACE-XPOS*) (IPLUS (CADR *WNDREGION*)*LAST-TRACE-YPOS*))</p><p class="s3" style="padding-top: 7pt;padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * Save what will be under the position of the new trace bitmap)</p><p class="s3" style="padding-top: 7pt;padding-left: 191pt;text-indent: -24pt;line-height: 88%;text-align: left;">(BITBLT (SCREENBITMAP) (IPLUS (CAR *WNDREGION*)</p><p class="s3" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: center;">xpos)</p><p class="s3" style="padding-left: 215pt;text-indent: -24pt;line-height: 88%;text-align: left;">(IPLUS (CADR *WNDREGION*) ypos)*OLDBITMAPPOSITION* 0 0)</p><p class="s3" style="padding-top: 7pt;padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * BITBLT the trace bitmap onto the new position of the mouse)</p><p class="s3" style="padding-top: 7pt;padding-left: 191pt;text-indent: -24pt;line-height: 88%;text-align: left;">(BITBLT *TRACEBITMAP* 0 0 (SCREENBITMAP) (IPLUS (CAR *WNDREGION*)</p><p class="s3" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: center;">xpos)</p><p class="s3" style="padding-left: 191pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(IPLUS (CADR *WNDREGION*)</p><p class="s3" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: center;">ypos)</p><p class="s3" style="padding-left: 191pt;text-indent: 0pt;line-height: 88%;text-align: left;">NIL NIL (QUOTE INPUT) (QUOTE PAINT))</p><p class="s3" style="padding-top: 6pt;padding-left: 167pt;text-indent: -24pt;line-height: 150%;text-align: left;">(* * Save the current position as the last trace position.) (SETQ *LAST-TRACE-XPOS* xpos)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-top: 5pt;padding-left: 167pt;text-indent: 0pt;text-align: left;">(SETQ *LAST-TRACE-YPOS* ypos]))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 107pt;text-indent: 0pt;line-height: 107%;text-align: left;">The helper function for <span class="s3">UNTRACE/CURSOR </span>, called <span class="s3">UNDO/TRACE/DATA</span>, must also be added to the environment:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 131pt;text-indent: -24pt;line-height: 88%;text-align: left;">(DEFINEQ (UNDO/TRACE/DATA [LAMBDA NIL</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 179pt;text-indent: -6pt;line-height: 88%;text-align: left;">(* * The purpose of this function is to turn tracing off and to free up the global variables used to trace the bitmap so that they can be garbage collected.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 179pt;text-indent: 0pt;line-height: 88%;text-align: left;">(* * Check if the cursor is currently being traced. It so, turn it off.)</p><p class="s3" style="padding-top: 9pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(UNTRACE/CURSOR)</p><p class="s3" style="padding-left: 215pt;text-indent: -72pt;line-height: 88%;text-align: left;">(WINDOWPROP *TRACEWINDOW*(QUOTE CURSORINFN) NIL)</p><p class="s3" style="padding-left: 215pt;text-indent: -72pt;line-height: 88%;text-align: left;">(WINDOWPROP *TRACEWINDOW*(QUOTE CURSOROUTFN) NIL)</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(SETQ *TRACEBITMAP* NIL)</p><p class="s3" style="padding-left: 143pt;text-indent: 0pt;line-height: 88%;text-align: left;">(SETQ *RIGHTTRACE/OFFSET* NIL) (SETQ *HEIGHTTRACE/OFFSET* NIL) (SETQ *OLDBITMAPPOSITION* NIL) (SETQ *TRACEWINDOW* NIL)</p><p class="s3" style="padding-top: 9pt;padding-left: 143pt;text-indent: 30pt;line-height: 177%;text-align: left;">(* * Turn GCGAG on) (GCGAG T]))</p><p style="padding-top: 7pt;padding-left: 107pt;text-indent: 0pt;line-height: 107%;text-align: left;">Finally, if you included the <span class="s3">WlNDOWPROP </span>to allow the user to place the bitmap in the window by pressing a mouse button, you must also type this function:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s3" style="padding-left: 131pt;text-indent: -24pt;line-height: 88%;text-align: left;">(DEFINEQ (PLACE/BITMAP/IN/WINDOW [LAMBDA (wnd)</p><p class="s3" style="padding-top: 9pt;padding-left: 143pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(UNADVISE (GETMOUSESTATE))</p><p class="s3" style="padding-left: 173pt;text-indent: -30pt;line-height: 88%;text-align: left;">(BITBLT *TRACEBITMAP* 0 0 (SCREENBITMAP) (IPLUS (CAR *WNDREGION*)</p><p class="s3" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: center;">xpos)</p><p class="s3" style="padding-left: 173pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(IPLUS (CADR *WNDREGION*)</p><p class="s3" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: center;">ypos)</p><p class="s3" style="padding-left: 173pt;text-indent: 0pt;line-height: 88%;text-align: left;">NIL NIL (QUOTE INPUT) (QUOTE PAINT]</p><p style="padding-top: 6pt;padding-left: 107pt;text-indent: 0pt;text-align: left;">That’s all the functions!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part138.htm">&lt; Previous</a><span> | </span><a href="../Medley-Primer.html">Contents</a><span> | </span><a href="part140.htm">Next &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
