(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)(FILECREATED "15-Apr-2018 19:10:08" {DSK}<Users>kaplan>Local>medley3.5>lispcore>library>SAMEDIR.;3 5140         changes to%:  (FNS CHECKSAMEDIR HOST&DIRECTORYFIELD)      previous date%: "12-Jun-90 11:18:52" {DSK}<Users>kaplan>Local>medley3.5>lispcore>library>SAMEDIR.;1)(* ; "Copyright (c) 1982, 1984, 1985, 1986, 1987, 1990, 2018 by Venue & Xerox Corporation.  All rights reserved.")(PRETTYCOMPRINT SAMEDIRCOMS)(RPAQQ SAMEDIRCOMS ((FNS CHECKSAMEDIR HOST&DIRECTORYFIELD)                        (ADDVARS [MAKEFILEFORMS (OR (NLSETQ (CHECKSAMEDIR FILE))                                                    (RETFROM 'MAKEFILE]                               (MIGRATIONS))                        (GLOBALVARS MIGRATIONS)))(DEFINEQ(CHECKSAMEDIR  [LAMBDA (FILE)                                        (* ; "Edited 15-Apr-2018 19:09 by rmk:")    (* ;; "Check (a) that we are writing FILE to the same directory we last read/wrote it and (b) that a version newer than the current one has not since appeared.")    (* ;; " OKHOST/DIRS is a list of places it's OK for the file to be winding up, so if your'e migrating code from one place ot another, you can do it gracefully.")    (PROG ((*UPPER-CASE-FILE-NAMES* NIL)           (DATES (GET (SETQ FILE (MKATOM (U-CASE FILE)))                       'FILEDATES))           HOST/DIR HOST DIR NEWV OKHOST/DIRS)      AGAIN          (OR (LISTP DATES)              (RETURN))                                      (* ;                    "RMK: Use HOST&DIRECTORYFIELD to canonicalize both file and connected directory")          [SETQ OKHOST/DIRS (CONS (SETQ HOST/DIR (HOST&DIRECTORYFIELD (DIRECTORYNAME T)))                                  (MKLIST (CDR (ASSOC HOST/DIR MIGRATIONS :TEST 'STRING-EQUAL]          (COND             ((for OLDFILE in DATES bind HOST DIR never (CL:MEMBER                                                                         (HOST&DIRECTORYFIELD                                                                          (CDR OLDFILE))                                                                         OKHOST/DIRS :TEST                                                                         'STRING-EQUAL))              (* ;; "The file is going somewhere it has never been before.  ")              (* ;; "Check that that is really what the user wants.")              (SELECTQ (ASKUSER 10 'Y (LIST "You haven't loaded or written" FILE                                             "in your connected directory" HOST/DIR                                             "-- write it out anyway")                              `((O ,(CONCAT "Oops!  Connect to " (SETQ HOST/DIR (                                                                               HOST&DIRECTORYFIELD                                                                                 (CDAR DATES)))                                           " [confirm] ")                                   CONFIRMFLG T)                                (C "Connect to other directory: ")                                (Y "Yes, write it here")                                (N "No, abort MAKEFILE"))                              NIL NIL '(NOECHOFLG T))                  (Y (RETURN))                  (N (ERROR!))                  (C (SETQ HOST/DIR))                  (O (TERPRI T))                  (SHOULDNT))              [NLSETQ (CNDIR (OR HOST/DIR (READ T T]              (GO AGAIN))             ([AND [SETQ NEWV (INFILEP (PACKFILENAME.STRING 'VERSION NIL 'BODY (CDAR DATES]                   (NOT (STRING-EQUAL NEWV (CDAR DATES]              (* ;; "A newer version appeared while the user was editing this file.")              (* ;; "Ask if he should over-write it.")              (SELECTQ (ASKUSER 15 'Y (LIST (CDAR DATES)                                            "is not the most recent version (version"                                            (MKSTRING (FILENAMEFIELD NEWV 'VERSION))                                            "has since appeared)."                                             "Do you want to make the file anyway"))                  (Y)                  (N (ERROR!))                  (SHOULDNT])(HOST&DIRECTORYFIELD  [LAMBDA (FILENAME)                                    (* ; "Edited 15-Apr-2018 19:05 by rmk:")    (* ;; "Returns the host&dir fields packed together.  HOST and device are upper cased")    (PACKFILENAME.STRING 'DEVICE (U-CASE (FILENAMEFIELD FILENAME 'DEVICE))           'HOST           (U-CASE (FILENAMEFIELD FILENAME 'HOST))           'DIRECTORY           (FILENAMEFIELD FILENAME 'DIRECTORY]))(ADDTOVAR MAKEFILEFORMS (OR (NLSETQ (CHECKSAMEDIR FILE))                                (RETFROM 'MAKEFILE)))(ADDTOVAR MIGRATIONS )(DECLARE%: DOEVAL@COMPILE DONTCOPY(GLOBALVARS MIGRATIONS))(PUTPROPS SAMEDIR COPYRIGHT ("Venue & Xerox Corporation" 1982 1984 1985 1986 1987 1990 2018))(DECLARE%: DONTCOPY  (FILEMAP (NIL (815 4817 (CHECKSAMEDIR 825 . 4374) (HOST&DIRECTORYFIELD 4376 . 4815)))))STOP