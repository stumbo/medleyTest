(DEFINE-FILE-INFO READTABLE "INTERLISP" PACKAGE "INTERLISP")(FILECREATED " 5-May-2018 09:46:37" {DSK}<Users>kaplan>Local>medley3.5>lispcore>library>CLIPBOARD.;22 12280        changes to%:  (FNS SEDIT.COPYTOCLIPBOARD)      previous date%: "28-Apr-2018 16:07:41" {DSK}<Users>kaplan>Local>medley3.5>lispcore>library>CLIPBOARD.;21)(PRETTYCOMPRINT CLIPBOARDCOMS)(RPAQQ CLIPBOARDCOMS       [                                                     (* ; "Enable copy and paste")        (FNS INSTALL-CLIPBOARD GETCLIPBOARD PUTCLIPBOARD PASTEFROMCLIPBOARD TEDIT.COPYTOCLIPBOARD              SEDIT.COPYTOCLIPBOARD LISPINTERRUPTS.PASTE)        (FNS UTF8.PRINTCCODE UTF8.READCCODE)                (* ;; "To read/access code translation tables")        (FNS FILETOCODETABLE CODECONVERT)        (DECLARE%: DONTEVAL@LOAD DOCOPY (FILES (SYSLOAD)                                               UNIXCOMM)               (P (INSTALL-CLIPBOARD)))        (DECLARE%: DONTEVAL@LOAD DOEVAL@COMPILE DONTCOPY COMPILERVARS (ADDVARS (NLAMA)                                                                             (NLAML)                                                                             (LAMA])(* ; "Enable copy and paste")(DEFINEQ(INSTALL-CLIPBOARD  [LAMBDA NIL                                           (* ; "Edited 18-Apr-2018 23:00 by rmk:")    (CL:WHEN (GETD 'LISPINTERRUPTS.PASTE)        (MOVD? 'LISPINTERRUPTS 'LISPINTERRUPTS.ORIG)        (MOVD 'LISPINTERRUPTS.PASTE 'LISPINTERRUPTS))    (INTERRUPTCHAR (CHARCODE "1,v")           '(PASTEFROMCLIPBOARD))    (INTERRUPTCHAR (CHARCODE "1,V")           '(PASTEFROMCLIPBOARD))    (CL:WHEN (BOUNDP 'TEDIT.READTABLE)                       (* ; "TEDIT")        (* ;; "Paste")        (TEDIT.SETFUNCTION (CHARCODE "1,v")               (FUNCTION PASTEFROMCLIPBOARD)               TEDIT.READTABLE)        (TEDIT.SETFUNCTION (CHARCODE "1,V")               (FUNCTION PASTEFROMCLIPBOARD)               TEDIT.READTABLE)        (* ;; "Copy")        (TEDIT.SETFUNCTION (CHARCODE "1,c")               (FUNCTION TEDIT.COPYTOCLIPBOARD)               TEDIT.READTABLE)        (TEDIT.SETFUNCTION (CHARCODE "1,C")               (FUNCTION TEDIT.COPYTOCLIPBOARD)               TEDIT.READTABLE))    (CL:WHEN (GETP 'SEDIT 'FILEDATES)                        (* ;                                                            "SEDIT copy: INTERRUPTCHAR does paste")        (SEDIT:ADD-COMMAND "1,c" 'SEDIT.COPYTOCLIPBOARD)        (SEDIT:ADD-COMMAND "1,C" 'SEDIT.COPYTOCLIPBOARD)        (SEDIT:RESET-COMMANDS))])(GETCLIPBOARD  [LAMBDA NIL                                           (* ; "Edited 25-Apr-2018 16:56 by rmk:")    (CL:WITH-OPEN-STREAM (s (CREATE-PROCESS-STREAM "pbpaste"))           [SETFILEINFO s 'ENDOFSTREAMOP #'(CL:LAMBDA (s)                                                  (RETFROM (FUNCTION UTF8.READCCODE)                                                         NIL]           (CONCATCODES (BIND C WHILE (SETQ C (UTF8.READCCODE s)) COLLECT C])(PUTCLIPBOARD  [CL:LAMBDA (STRING)                                   (* ; "Edited 25-Apr-2018 16:49 by rmk:")         (* ;; "Clipboard is UTF8")         (CL:WITH-OPEN-STREAM (s (CREATE-PROCESS-STREAM "pbcopy"))                (FOR I FROM 1 TO (NCHARS STRING) DO (UTF8.PRINTCCODE (NTHCHARCODE                                                                                          STRING I)                                                                           s])(PASTEFROMCLIPBOARD  [LAMBDA NIL                                           (* ; "Edited 18-Apr-2018 13:56 by rmk:")                                                            (* ; "Edited 17-Apr-2018 23:11 by rmk:")    (* ;;   "Should be able to just call COPYINSERT, but the default BKSYSBUF puts in string qujotes ")    (LET ((STR (GETCLIPBOARD)))         (IF (WINDOWPROP (PROCESS.WINDOW (TTY.PROCESS))                        'COPYINSERTFN)             THEN (COPYINSERT STR)           ELSE (BIND C WHILE (SETQ C (GNCCODE STR)) DO (BKSYSCHARCODE C])(TEDIT.COPYTOCLIPBOARD  [LAMBDA NIL                                           (* ; "Edited 18-Apr-2018 00:02 by rmk:")    (LET [(TEXTSTREAM (TEXTSTREAM (TTY.PROCESS]         (IF TEXTSTREAM             THEN (PUTCLIPBOARD (TEDIT.SEL.AS.STRING TEXTSTREAM])(SEDIT.COPYTOCLIPBOARD  [LAMBDA (CONTEXT)                                     (* ; "Edited  5-May-2018 09:43 by rmk:")                                                            (* ; "Edited 24-Apr-2018 20:39 by rmk:")                                                            (* ; "Edited 24-Apr-2018 20:33 by rmk:")                                                            (* ; "Edited 23-Apr-2018 18:19 by rmk:")    (LET (SEL SELTYPE STRING)         (* ;; "SEL could be a list of several elements, or a structure, depending on SELTYPE.  ")         (CL:MULTIPLE-VALUE-SETQ (SEL SELTYPE)                (SEDIT:GET-SELECTION CONTEXT))         (* ;; "SELTYPE=NIL means not a valid selection, and SEL is NIL.  Non-NIL values are :SUB-LIST, :CHARACTERS, and T")         (IF SELTYPE             THEN (SETQ STRING (MKSTRING SEL T))         (* ; " Readtable of caller?")                   (CL:WHEN (OR (EQ SELTYPE :CHARACTERS)                                (AND (EQ SELTYPE :SUB-LIST)                                     (LISTP SEL)))                       (GNC STRING)                          (* ;                         "Peel off outer parens for structures or quotes for atom/string characters")                       (GLC STRING))                   (PUTCLIPBOARD STRING)))    T])(LISPINTERRUPTS.PASTE  [LAMBDA NIL                                           (* ; "Edited 18-Apr-2018 22:59 by rmk:")    (* ;; "So paste interrupts will be installed in every process")    (APPEND [LIST (LIST (CHARCODE "1,v")                        '(PASTEFROMCLIPBOARD))                  (LIST (CHARCODE "1,V")                        '(PASTEFROMCLIPBOARD]           (LISPINTERRUPTS.ORIG]))(DEFINEQ(UTF8.PRINTCCODE  [LAMBDA (CHARCODE FILE)                               (* ; "Edited 25-Apr-2018 17:56 by rmk:")    (* ;; "PRINT UTF8 sequence for CHARACODE.  Doesn't do XNS to Unicode character conversion, just does the transport encoding.")    (LET [(STRM (\GETSTREAM FILE 'OUTPUT]                    (* ; "Output raw bytes")         (IF (ILESSP CHARCODE 128)             THEN (\BOUT STRM CHARCODE)           ELSEIF (ILESSP CHARCODE 2048)             THEN                                        (* ; "x800")                   (\BOUT STRM (LOGOR (LLSH 3 6)                                      (LRSH CHARCODE 6)))                   (\BOUT STRM (LOGOR (LLSH 2 6)                                      (LOADBYTE CHARCODE 0 6)))           ELSEIF (ILESSP CHARCODE 65536)             THEN                                        (* ; "x10000")                   (\BOUT STRM (LOGOR (LLSH 7 5)                                      (LRSH CHARCODE 12)))                   (\BOUT STRM (LOGOR (LLSH 2 6)                                      (LOADBYTE CHARCODE 6 6)))                   (\BOUT STRM (LOGOR (LLSH 2 6)                                      (LOADBYTE CHARCODE 0 6)))           ELSEIF (ILESSP CHARCODE 2097152)             THEN                                        (* ; "x200000")                   (\BOUT STRM (LOGOR (LLSH 15 4)                                      (LRSH CHARCODE 18)))                   (\BOUT STRM (LOGOR (LLSH 2 6)                                      (LOADBYTE CHARCODE 12 6)))                   (\BOUT STRM (LOGOR (LLSH 2 6)                                      (LOADBYTE CHARCODE 6 6)))                   (\BOUT STRM (LOGOR (LLSH 2 6)                                      (LOADBYTE CHARCODE 0 6)))           ELSE (ERROR "CHARCODE too big for UTF8" CHARCODE])(UTF8.READCCODE  [LAMBDA (FILE)                                        (* ; "Edited 25-Apr-2018 17:23 by rmk:")    (LET ((STRM (\GETSTREAM FILE 'INPUT))          BYTE1 BYTE2 BYTE3 BYTE4)         (SETQ BYTE1 (\BIN STRM))         (* ;; "Distinguish on header byte, extract number of bytes so we don't read too far")         (IF (ILESSP BYTE1 128)             THEN                    (* ;; "Test first:  Ascii is the common case")                   BYTE1           ELSEIF (IGEQ BYTE1 (LLSH 15 4))             THEN                                        (* ; "4 bytes")                   (SETQ BYTE2 (\BIN STRM))                   (CL:WHEN (ILESSP BYTE2 128)                       (ERROR "INVALID UTF8 SEQUENCE" (LIST BYTE1 BYTE2)))                   (SETQ BYTE3 (\BIN STRM))                   (CL:WHEN (ILESSP BYTE3 128)                       (ERROR "INVALID UTF8 SEQUENCE" (LIST BYTE1 BYTE2 BYTE3)))                   (SETQ BYTE4 (\BIN STRM))                   (CL:WHEN (ILESSP BYTE4 128)                       (ERROR "INVALID UTF8 SEQUENCE" (LIST BYTE1 BYTE2 BYTE3 BYTE4)))                   (LOGOR (LLSH (LOADBYTE BYTE1 0 3)                                18)                          (LLSH (LOADBYTE BYTE2 0 6)                                12)                          (LLSH (LOADBYTE BYTE3 0 6)                                6)                          (LOADBYTE BYTE4 0 6))           ELSEIF (IGEQ BYTE1 (LLSH 7 5))             THEN                                        (* ; "3 bytes")                   (SETQ BYTE2 (\BIN STRM))                   (CL:WHEN (ILESSP BYTE2 128)                       (ERROR "INVALID UTF8 SEQUENCE" (LIST BYTE1 BYTE2)))                   (SETQ BYTE3 (\BIN STRM))                   (CL:WHEN (ILESSP BYTE3 128)                       (ERROR "INVALID UTF8 SEQUENCE" (LIST BYTE1 BYTE2 BYTE3)))                   (LOGOR (LLSH (LOADBYTE BYTE1 0 4)                                12)                          (LLSH (LOADBYTE BYTE2 0 6)                                6)                          (LOADBYTE BYTE3 0 6))           ELSE                                          (* ; "Must be 2 bytes")                 (SETQ BYTE2 (\BIN STRM))                 (CL:WHEN (ILESSP BYTE2 128)                     (ERROR "INVALID UTF8 SEQUENCE" (LIST BYTE1 BYTE2)))                 (LOGOR (LLSH (LOADBYTE BYTE1 0 5)                              6)                        (LOADBYTE BYTE2 0 6]))(* ;; "To read/access code translation tables")(DEFINEQ(FILETOCODETABLE  [LAMBDA (FILE)                                        (* ; "Edited 28-Apr-2018 16:07 by rmk:")                                                             (* rmk%: "20-Dec-87 10:08")    (* ;; "Returns a (system-internal) arrayblock holding the contents of FILE.")    (RESETLST        (LET (LENGTH BLOCK STREAM)             (CL:UNLESS (AND (STREAMP FILE)                             (SETQ STREAM (GETSTREAM FILE 'INPUT T)))                 [RESETSAVE [SETQ STREAM (OPENSTREAM FILE 'INPUT 'OLD '((SEQUENTIAL T)                                                                        (TYPE BINARY]                        '(PROGN (CLOSEF? OLDVALUE])             (* ;; "Blocks are allocated in 4-byte units")             (SETQ BLOCK (\ALLOCBLOCK (LRSH LENGTH 2)))             (\BINS STREAM BLOCK 0 LENGTH)             BLOCK))])(CODECONVERT  [LAMBDA (TABLE CODE)                                  (* ; "Edited 28-Apr-2018 16:01 by rmk:")    (* ;;   "Get the CODEth value from the arrayblock TABLE.  CODE is a 16-bit index, 16 bits are returned.")    (\GETBASE TABLE CODE]))(DECLARE%: DONTEVAL@LOAD DOCOPY (FILESLOAD (SYSLOAD)       UNIXCOMM)(INSTALL-CLIPBOARD))(DECLARE%: DONTEVAL@LOAD DOEVAL@COMPILE DONTCOPY COMPILERVARS (ADDTOVAR NLAMA )(ADDTOVAR NLAML )(ADDTOVAR LAMA ))(PUTPROPS CLIPBOARD COPYRIGHT (NONE))(DECLARE%: DONTCOPY  (FILEMAP (NIL (1259 6345 (INSTALL-CLIPBOARD 1269 . 2642) (GETCLIPBOARD 2644 . 3128) (PUTCLIPBOARD 3130 . 3642) (PASTEFROMCLIPBOARD 3644 . 4261) (TEDIT.COPYTOCLIPBOARD 4263 . 4544) (SEDIT.COPYTOCLIPBOARD 4546 . 5920) (LISPINTERRUPTS.PASTE 5922 . 6343)) (6346 10761 (UTF8.PRINTCCODE 6356 . 8238) (UTF8.READCCODE 8240 . 10759)) (10818 11986 (FILETOCODETABLE 10828 . 11713) (CODECONVERT 11715 . 11984)))))STOP